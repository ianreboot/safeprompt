# CORS Security Audit Report
**Date**: 2025-10-04 03:47 UTC
**Scope**: All API endpoints in `/home/projects/safeprompt/api/api/`
**Auditor**: Claude Code (Phase 0.2 - Launch Readiness)

## Executive Summary

**Total Files Audited**: 5
**Files Requiring Updates**: 4
**Critical Issues**: 1 (wildcard CORS in admin.js)
**Localhost Issues**: 3 files

## Detailed Findings

### ‚úÖ SECURE (No Changes Needed)

#### 1. website.js (Lines 393-397)
**Status**: ‚úÖ SECURE - No localhost origins
**Current Configuration**:
```javascript
const allowedOrigins = [
  'https://safeprompt.dev',
  'https://www.safeprompt.dev',
  'https://dev.safeprompt.dev',
  'https://dev-dashboard.safeprompt.dev'
];
```
**Action**: None required

---

### ‚ö†Ô∏è REQUIRES UPDATE (Localhost in Production)

#### 2. stripe-checkout.js (Lines 24-27)
**Status**: ‚ö†Ô∏è HAS LOCALHOST
**Current Configuration**:
```javascript
const allowedOrigins = [
  'https://dashboard.safeprompt.dev',
  'https://dev-dashboard.safeprompt.dev',
  'http://localhost:3000'  // ‚Üê REMOVE IN PRODUCTION
];
```
**Issue**: Localhost allowed in production could enable local proxy attacks
**Fix Required**: Implement environment-based CORS (see recommendations below)

---

#### 3. stripe-portal.js (Lines 17-20)
**Status**: ‚ö†Ô∏è HAS LOCALHOST
**Current Configuration**:
```javascript
const allowedOrigins = [
  'https://dashboard.safeprompt.dev',
  'https://dev-dashboard.safeprompt.dev',
  'http://localhost:3000'  // ‚Üê REMOVE IN PRODUCTION
];
```
**Issue**: Localhost allowed in production could enable local proxy attacks
**Fix Required**: Implement environment-based CORS (see recommendations below)

---

#### 4. v1/validate.js (Lines 28-35)
**Status**: ‚ö†Ô∏è HAS LOCALHOST (2 instances)
**Current Configuration**:
```javascript
const allowedOrigins = [
  'https://safeprompt.dev',
  'https://www.safeprompt.dev',
  'https://dashboard.safeprompt.dev',
  'https://dev.safeprompt.dev',
  'https://dev-dashboard.safeprompt.dev',
  'http://localhost:3000',   // ‚Üê REMOVE IN PRODUCTION
  'http://localhost:5173'    // ‚Üê REMOVE IN PRODUCTION
];
```
**Issue**: Multiple localhost ports allowed in production
**Fix Required**: Implement environment-based CORS (see recommendations below)

---

### üî¥ CRITICAL SECURITY ISSUE

#### 5. admin.js (Line 468)
**Status**: üî¥ WILDCARD CORS - CRITICAL
**Current Configuration**:
```javascript
res.setHeader('Access-Control-Allow-Origin', '*');  // ‚Üê ALLOWS ANY ORIGIN
res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-API-Key, Authorization');
```
**Issue**: Wildcard CORS allows ANY website to call admin endpoints
**Attack Vector**: XSS attack on any site ‚Üí steal admin credentials ‚Üí abuse admin API
**Fix Required**:
1. Implement strict origin whitelist (dashboard only)
2. Consider removing CORS entirely (admin endpoints should be server-to-server)

---

## Recommended Fix Pattern

### Environment-Based CORS Configuration

```javascript
// Detect production environment
const isProd = process.env.NODE_ENV === 'production' ||
               process.env.VERCEL_ENV === 'production';

// Set allowed origins based on environment
const allowedOrigins = isProd
  ? [
      // PRODUCTION: Only production domains
      'https://dashboard.safeprompt.dev',
      'https://safeprompt.dev',
      'https://www.safeprompt.dev'
    ]
  : [
      // DEVELOPMENT: Include localhost and dev domains
      'https://dev-dashboard.safeprompt.dev',
      'https://dev.safeprompt.dev',
      'http://localhost:3000',
      'http://localhost:5173'
    ];

// Apply CORS headers
const origin = req.headers.origin || req.headers.referer;
if (origin && allowedOrigins.some(allowed => origin.startsWith(allowed))) {
  res.setHeader('Access-Control-Allow-Origin', origin);
}
```

### Admin Endpoint Specific Fix

```javascript
// Option A: Strict whitelist (recommended)
const allowedOrigins = ['https://dashboard.safeprompt.dev'];
const origin = req.headers.origin || req.headers.referer;
if (origin && allowedOrigins.includes(origin)) {
  res.setHeader('Access-Control-Allow-Origin', origin);
}

// Option B: Remove CORS entirely (if admin is server-to-server only)
// Do not set any Access-Control-Allow-Origin header
```

---

## Implementation Priority

### Phase 1.4 (Launch Blocker) - Must fix before Product Hunt:
1. ‚úÖ **admin.js** - Remove wildcard CORS (lines 468-470)
2. ‚úÖ **stripe-checkout.js** - Implement environment-based CORS (lines 24-32)
3. ‚úÖ **stripe-portal.js** - Implement environment-based CORS (lines 17-25)
4. ‚úÖ **v1/validate.js** - Implement environment-based CORS (lines 28-40)

### Testing Checklist:
- [ ] Test production dashboard can access API (should work)
- [ ] Test localhost access in dev environment (should work)
- [ ] Test localhost access in production (should FAIL with CORS error)
- [ ] Test admin endpoints from unauthorized origin (should FAIL)

---

## Files Summary

| File | Lines | Status | Issue | Priority |
|------|-------|--------|-------|----------|
| website.js | 393-409 | ‚úÖ Secure | None | - |
| stripe-checkout.js | 24-36 | ‚ö†Ô∏è Has Localhost | `http://localhost:3000` | P0 |
| stripe-portal.js | 17-29 | ‚ö†Ô∏è Has Localhost | `http://localhost:3000` | P0 |
| v1/validate.js | 28-44 | ‚ö†Ô∏è Has Localhost | `http://localhost:3000`, `http://localhost:5173` | P0 |
| admin.js | 468-470 | üî¥ Wildcard | `Access-Control-Allow-Origin: *` | P0 CRITICAL |

---

## References
- OWASP CORS Security Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/CORS_Cheat_Sheet.html
- MDN CORS Documentation: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
- Related: LAUNCH_READINESS_FIXES.md Phase 1.4

---

**Audit Complete**: 2025-10-04 03:47 UTC
**Next Step**: Implement fixes in Phase 1.4
**Estimated Time**: 45 minutes (as per launch readiness plan)
